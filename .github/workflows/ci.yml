# GitHub Actions CI workflow for Event Registration module
# Validates that the Drupal module installs correctly and database schema is created

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Drupal Module Installation Test
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: drupal
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: module-repo

      # Step 2: Setup PHP with required extensions
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, pdo, pdo_mysql, gd, xml, curl, zip
          coverage: none
          tools: composer:v2

      # Step 3: Create Drupal project
      - name: Create Drupal project
        run: |
          composer create-project drupal/recommended-project:^10.0 drupal --no-interaction
          cd drupal
          composer require drush/drush --no-interaction

      # Step 4: Copy custom module to Drupal
      - name: Copy custom module
        run: |
          mkdir -p drupal/web/modules/custom
          cp -r module-repo/web/modules/custom/event_registration drupal/web/modules/custom/

      # Step 5: Wait for MySQL to be ready
      - name: Wait for MySQL
        run: |
          while ! mysqladmin ping -h"127.0.0.1" --silent; do
            sleep 1
          done

      # Step 6: Install Drupal site
      - name: Install Drupal
        run: |
          cd drupal
          ./vendor/bin/drush site:install standard \
            --db-url=mysql://root:root@127.0.0.1:3306/drupal \
            --account-name=admin \
            --account-pass=admin \
            --site-name="Event Registration Test" \
            -y

      # Step 7: Enable the event_registration module
      - name: Enable Event Registration module
        run: |
          cd drupal
          ./vendor/bin/drush en event_registration -y
          ./vendor/bin/drush cr

      # Step 8: Verify module is enabled
      - name: Verify module is enabled
        run: |
          cd drupal
          MODULE_STATUS=$(./vendor/bin/drush pm:list --status=enabled --format=list | grep -c "event_registration" || true)
          if [ "$MODULE_STATUS" -eq "0" ]; then
            echo "ERROR: event_registration module is not enabled"
            exit 1
          fi
          echo "✓ event_registration module is enabled"

      # Step 9: Verify database tables exist
      - name: Verify database tables exist
        run: |
          cd drupal
          # Check event_configurations table
          CONFIG_TABLE=$(./vendor/bin/drush sqlq "SHOW TABLES LIKE 'event_configurations';" | grep -c "event_configurations" || true)
          if [ "$CONFIG_TABLE" -eq "0" ]; then
            echo "ERROR: event_configurations table does not exist"
            exit 1
          fi
          echo "✓ event_configurations table exists"

          # Check event_registrations table
          REG_TABLE=$(./vendor/bin/drush sqlq "SHOW TABLES LIKE 'event_registrations';" | grep -c "event_registrations" || true)
          if [ "$REG_TABLE" -eq "0" ]; then
            echo "ERROR: event_registrations table does not exist"
            exit 1
          fi
          echo "✓ event_registrations table exists"

      # Step 10: Verify routes are registered
      - name: Verify routes are registered
        run: |
          cd drupal
          ROUTES=$(./vendor/bin/drush route 2>/dev/null | grep -c "event_registration" || true)
          if [ "$ROUTES" -lt "4" ]; then
            echo "WARNING: Expected at least 4 event_registration routes, found $ROUTES"
          else
            echo "✓ All $ROUTES event_registration routes are registered"
          fi

      - name: CI Passed
        run: |
          echo "============================================"
          echo "✓ All CI checks passed!"
          echo "  - Drupal installed successfully"
          echo "  - Module enabled successfully"
          echo "  - Database tables created"
          echo "  - Routes registered"
          echo "============================================"
